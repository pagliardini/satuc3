<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Sedes, Unidades y Áreas - SATUCC3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- CSS específico para lugares -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lugares.css') }}">
</head>
<body>
<!-- Navbar (incluida desde archivo separado) -->
{% include 'partials/_navbar.html' %}

<div id="app">
    {% raw %}
    <!-- Overlay de carga -->
    <div id="loading-overlay" v-if="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
    <div class="container mt-4">
        <h1 class="mb-4">Catálogo de Sedes, Unidades y Áreas</h1>
        <ul class="nav nav-tabs mb-3" id="catalogTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" :class="{active: tab==='sedes'}" @click="tab='sedes'" type="button" role="tab">Sedes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" :class="{active: tab==='unidades'}" @click="tab='unidades'" type="button" role="tab">Unidades Organizativas</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" :class="{active: tab==='areas'}" @click="tab='areas'" type="button" role="tab">Áreas</button>
            </li>
        </ul>
        
        <!-- SEDES -->
        <div v-show="tab==='sedes'">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-8"><h5 class="mb-0">Listado de Sedes</h5></div>
                        <div class="col-md-4">
                            <input type="text" v-model="searchSede" class="form-control" placeholder="Buscar...">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th style="width:120px;">Acciones</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="sede in filteredSedes" :key="sede.id">
                                <td>{{ sede.id }}</td>
                                <td>
                                    <span v-if="editSedeId !== sede.id">{{ sede.nombre }}</span>
                                    <input v-else v-model="editSedeNombre" class="form-control form-control-sm" />
                                </td>
                                <td>
                                    <button v-if="editSedeId !== sede.id" class="btn btn-sm btn-outline-secondary me-1" @click="startEditSede(sede)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button v-else class="btn btn-sm btn-success me-1" @click="saveEditSede(sede)">
                                        <i class="bi bi-check"></i>
                                    </button>
                                    <button v-if="editSedeId === sede.id" class="btn btn-sm btn-secondary me-1" @click="cancelEditSede">
                                        <i class="bi bi-x"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteSede(sede)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div v-if="sedes.length === 0" class="alert alert-info mt-3">
                        No hay sedes registradas.
                    </div>
                </div>
            </div>
            <!-- Formulario para agregar nueva sede -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Agregar Nueva Sede</h5>
                </div>
                <div class="card-body">
                    <form @submit.prevent="addSede">
                        <div class="row">
                            <div class="col-md-8 mb-2">
                                <input type="text" v-model="newSedeNombre" class="form-control" placeholder="Nombre de la sede" required>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button type="submit" class="btn btn-primary w-100">Agregar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- UNIDADES -->
        <div v-show="tab==='unidades'">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-8"><h5 class="mb-0">Listado de Unidades Organizativas</h5></div>
                        <div class="col-md-4">
                            <input type="text" v-model="searchUnidad" class="form-control" placeholder="Buscar...">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Sede</th>
                                <th style="width:120px;">Acciones</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="unidad in filteredUnidades" :key="unidad.id">
                                <td>{{ unidad.id }}</td>
                                <td>
                                    <span v-if="editUnidadId !== unidad.id">{{ unidad.nombre }}</span>
                                    <input v-else v-model="editUnidadNombre" class="form-control form-control-sm" />
                                </td>
                                <td>
                                    <span v-if="editUnidadId !== unidad.id">{{ getSedeNombre(unidad.sede_id) }}</span>
                                    <select v-else v-model="editUnidadSedeId" class="form-select form-select-sm">
                                        <option v-for="sede in sedes" :value="sede.id">{{ sede.nombre }}</option>
                                    </select>
                                </td>
                                <td>
                                    <button v-if="editUnidadId !== unidad.id" class="btn btn-sm btn-outline-secondary me-1" @click="startEditUnidad(unidad)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button v-else class="btn btn-sm btn-success me-1" @click="saveEditUnidad(unidad)">
                                        <i class="bi bi-check"></i>
                                    </button>
                                    <button v-if="editUnidadId === unidad.id" class="btn btn-sm btn-secondary me-1" @click="cancelEditUnidad">
                                        <i class="bi bi-x"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteUnidad(unidad)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div v-if="unidades.length === 0" class="alert alert-info mt-3">
                        No hay unidades organizativas registradas.
                    </div>
                </div>
            </div>
            <!-- Formulario para agregar nueva unidad -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Agregar Nueva Unidad Organizativa</h5>
                </div>
                <div class="card-body">
                    <form @submit.prevent="addUnidad">
                        <div class="row">
                            <div class="col-md-5 mb-2">
                                <input type="text" v-model="newUnidadNombre" class="form-control" placeholder="Nombre de la unidad" required>
                            </div>
                            <div class="col-md-5 mb-2">
                                <select v-model="newUnidadSedeId" class="form-select" required>
                                    <option value="" disabled>Seleccione sede</option>
                                    <option v-for="sede in sedes" :value="sede.id">{{ sede.nombre }}</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <button type="submit" class="btn btn-primary w-100">Agregar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- AREAS -->
        <div v-show="tab==='areas'">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-8"><h5 class="mb-0">Listado de Áreas</h5></div>
                        <div class="col-md-4">
                            <input type="text" v-model="searchArea" class="form-control" placeholder="Buscar...">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Unidad Organizativa</th>
                                <th>¿Depósito?</th>
                                <th style="width:120px;">Acciones</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="area in filteredAreas" :key="area.id">
                                <td>{{ area.id }}</td>
                                <td>
                                    <span v-if="editAreaId !== area.id">{{ area.nombre }}</span>
                                    <input v-else v-model="editAreaNombre" class="form-control form-control-sm" />
                                </td>
                                <td>
                                    <span v-if="editAreaId !== area.id">{{ getUnidadNombre(area.unidad_organizativa_id) }}</span>
                                    <select v-else v-model="editAreaUnidadId" class="form-select form-select-sm">
                                        <option v-for="unidad in unidades" :value="unidad.id">{{ unidad.nombre }}</option>
                                    </select>
                                </td>
                                <td>
                                    <span v-if="area.es_deposito" class="badge bg-success">Sí</span>
                                    <span v-else class="badge bg-secondary">No</span>
                                    <button v-if="!area.es_deposito" class="btn btn-sm btn-outline-primary ms-2" @click="setDeposito(area)">
                                        <i class="bi bi-box-arrow-in-down"></i>
                                    </button>
                                </td>
                                <td>
                                    <button v-if="editAreaId !== area.id" class="btn btn-sm btn-outline-secondary me-1" @click="startEditArea(area)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button v-else class="btn btn-sm btn-success me-1" @click="saveEditArea(area)">
                                        <i class="bi bi-check"></i>
                                    </button>
                                    <button v-if="editAreaId === area.id" class="btn btn-sm btn-secondary me-1" @click="cancelEditArea">
                                        <i class="bi bi-x"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteArea(area)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div v-if="areas.length === 0" class="alert alert-info mt-3">
                        No hay áreas registradas.
                    </div>
                </div>
            </div>
            <!-- Formulario para agregar nueva área -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Agregar Nueva Área</h5>
                </div>
                <div class="card-body">
                    <form @submit.prevent="addArea">
                        <div class="row">
                            <div class="col-md-5 mb-2">
                                <input type="text" v-model="newAreaNombre" class="form-control" placeholder="Nombre del área" required>
                            </div>
                            <div class="col-md-5 mb-2">
                                <select v-model="newAreaUnidadId" class="form-select" required>
                                    <option value="" disabled>Seleccione unidad organizativa</option>
                                    <option v-for="unidad in unidades" :value="unidad.id">{{ unidad.nombre }}</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <button type="submit" class="btn btn-primary w-100">Agregar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast para mensajes -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="resultToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header" :class="toastClass">
                <strong class="me-auto" v-text="toastTitle"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" v-text="toastMessage"></div>
        </div>
    </div>
    {% endraw %}
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<!-- Scripts de autenticación -->
<script src="{{ url_for('static', filename='js/auth/auth.js') }}"></script>
<script src="{{ url_for('static', filename='js/auth/axios-config.js') }}"></script>
<script src="{{ url_for('static', filename='js/auth/auth-check.js') }}"></script>

<!-- Módulos JS de lugares -->
<script src="{{ url_for('static', filename='js/lugares/data.js') }}"></script>
<script src="{{ url_for('static', filename='js/lugares/computed.js') }}"></script>
<script src="{{ url_for('static', filename='js/lugares/methods/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/lugares/methods/sedes.js') }}"></script>
<script src="{{ url_for('static', filename='js/lugares/methods/unidades.js') }}"></script>
<script src="{{ url_for('static', filename='js/lugares/methods/areas.js') }}"></script>
<script src="{{ url_for('static', filename='js/lugares/app.js') }}"></script>

</body>
</html>