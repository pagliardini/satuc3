<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Stock - SATUCC3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
        .nav-tabs .nav-link.active { font-weight: bold; border-bottom: 3px solid #0d6efd; }
        .table-responsive { max-height: 500px; overflow-y: auto; }
        .table th { position: sticky; top: 0; background-color: white; z-index: 1; }
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; justify-content:center; align-items:center; z-index:9999; }
        .spinner-border { width: 3rem; height: 3rem; }
        .badge-inventariable { background-color: #198754; }
        .badge-no-inventariable { background-color: #6c757d; }
    </style>
</head>
<body>
<div id="app">
    {% raw %}
    <!-- Overlay de carga -->
    <div id="loading-overlay" v-if="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
    
    <div class="container mt-4">
        <h1 class="mb-4">Gestión de Stock</h1>
        
        <!-- Pestañas -->
        <ul class="nav nav-tabs mb-3" id="stockTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" :class="{active: tab==='stock'}" @click="tab='stock'" type="button">Stock Actual</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" :class="{active: tab==='insumos'}" @click="tab='insumos'" type="button">Catálogo de Insumos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" :class="{active: tab==='imputar'}" @click="tab='imputar'" type="button">Imputar Stock</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" :class="{active: tab==='mover'}" @click="tab='mover'" type="button">Mover Stock</button>
            </li>
        </ul>

        <!-- TAB: Stock Actual -->
        <div v-show="tab==='stock'">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">Stock Actual por Ubicación</h5>
                        </div>
                        <div class="col-md-3">
                            <!-- Radio buttons para filtrar por tipo -->
                            <div class="btn-group" role="group" aria-label="Filtro de tipo">
                                <input type="radio" class="btn-check" name="tipoFiltro" id="impresoras" value="impresoras" v-model="stockFilter">
                                <label class="btn btn-outline-primary" for="impresoras">Impresoras</label>
                                
                                <input type="radio" class="btn-check" name="tipoFiltro" id="ups" value="ups" v-model="stockFilter">
                                <label class="btn btn-outline-primary" for="ups">UPS</label>
                                
                                <input type="radio" class="btn-check" name="tipoFiltro" id="todos" value="todos" v-model="stockFilter" checked>
                                <label class="btn btn-outline-primary" for="todos">Todos</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <input type="text" v-model="searchStock" class="form-control" placeholder="Buscar en stock...">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Vista para Impresoras -->
                    <div v-if="stockFilter === 'impresoras'" class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Impresora</th>
                                <th>Área</th>
                                <th>Tóner</th>
                                <th>Cantidad</th>
                                <th>Código</th>
                                <th>Estado</th>
                                <th>Último Movimiento</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="item in filteredStockImpresoras" :key="item.id">
                                <td>
                                    <div class="text-center" style="width: 60px;">
                                        <img v-if="item.insumo.url_imagen" 
                                             :src="item.insumo.url_imagen" 
                                             :alt="item.insumo.nombre_completo"
                                             class="img-thumbnail"
                                             style="max-width: 50px; max-height: 50px; object-fit: cover;"
                                             @error="onImageError($event)">
                                        <div v-else class="bg-light rounded d-flex align-items-center justify-content-center" 
                                             style="width: 50px; height: 50px; font-size: 12px; color: #6c757d;">
                                            Sin imagen
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ item.insumo.marca ? item.insumo.marca.nombre : 'Sin marca' }} {{ item.insumo.modelo ? item.insumo.modelo.nombre : 'Sin modelo' }}</strong>
                                        <small v-if="item.insumo.descripcion" class="text-muted d-block">{{ item.insumo.descripcion }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge" :class="item.area.es_deposito ? 'bg-warning text-dark' : 'bg-primary'">
                                        {{ item.area.nombre }}
                                </span>
                                </td>
                                <td>
                                    <span v-if="item.insumo.toner" class="badge bg-info">
                                        {{ item.insumo.toner }}
                                    </span>
                                    <span v-else class="text-muted">—</span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ item.cantidad }}</span>
                                </td>
                                <td>
                                    <code v-if="item.codigo" class="small">{{ item.codigo }}</code>
                                    <span v-else class="text-muted">—</span>
                                </td>
                                <td>
                                    <span class="badge" :class="getEstadoBadgeClass(item.estado)">{{ item.estado }}</span>
                                </td>
                                <td class="small">{{ formatDate(item.ultimo_movimiento) }}</td>
                            </tr>
                            </tbody>
                        </table>
                        <div v-if="filteredStockImpresoras.length === 0" class="alert alert-info">
                            No hay impresoras registradas en stock.
                        </div>
                    </div>

                    <!-- Vista para UPS -->
                    <div v-else-if="stockFilter === 'ups'" class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>UPS</th>
                                <th>Área</th>
                                <th>Batería</th>
                                <th>Cantidad</th>
                                <th>Código</th>
                                <th>Estado</th>
                                <th>Último Movimiento</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="item in filteredStockUps" :key="item.id">
                                <td>
                                    <div class="text-center" style="width: 60px;">
                                        <img v-if="item.insumo.url_imagen" 
                                             :src="item.insumo.url_imagen" 
                                             :alt="item.insumo.nombre_completo"
                                             class="img-thumbnail"
                                             style="max-width: 50px; max-height: 50px; object-fit: cover;"
                                             @error="onImageError($event)">
                                        <div v-else class="bg-light rounded d-flex align-items-center justify-content-center" 
                                             style="width: 50px; height: 50px; font-size: 12px; color: #6c757d;">
                                            Sin imagen
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ item.insumo.marca ? item.insumo.marca.nombre : 'Sin marca' }} {{ item.insumo.modelo ? item.insumo.modelo.nombre : 'Sin modelo' }}</strong>
                                        <small v-if="item.insumo.descripcion" class="text-muted d-block">{{ item.insumo.descripcion }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge" :class="item.area.es_deposito ? 'bg-warning text-dark' : 'bg-primary'">
                                        {{ item.area.nombre }}
                            </span>
                                </td>
                                <td>
                                    <span v-if="item.insumo.bateria" class="badge bg-success">
                                        {{ item.insumo.bateria }} mAh
                            </span>
                                    <span v-else class="text-muted">—</span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ item.cantidad }}</span>
                                </td>
                                <td>
                                    <code v-if="item.codigo" class="small">{{ item.codigo }}</code>
                                    <span v-else class="text-muted">—</span>
                                </td>
                                <td>
                                    <span class="badge" :class="getEstadoBadgeClass(item.estado)">{{ item.estado }}</span>
                                </td>
                                <td class="small">{{ formatDate(item.ultimo_movimiento) }}</td>
                            </tr>
                            </tbody>
                        </table>
                        <div v-if="filteredStockUps.length === 0" class="alert alert-info">
                            No hay UPS registrados en stock.
                        </div>
                    </div>

                    <!-- Vista General (Todos) - Vista original -->
                    <div v-else class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Insumo</th>
                                <th>Área</th>
                                <th>Cantidad</th>
                                <th>Código</th>
                                <th>Estado</th>
                                <th>Tipo</th>
                                <th>Último Movimiento</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="item in filteredStock" :key="item.id">
                                <td>
                                    <div>
                                        <strong>{{ item.insumo.nombre_completo }}</strong>
                                        <small v-if="item.insumo.descripcion" class="text-muted d-block">{{ item.insumo.descripcion }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge" :class="item.area.es_deposito ? 'bg-warning text-dark' : 'bg-primary'">
                                        {{ item.area.nombre }}
                            </span>
                                </td>
                                <td>{{ item.cantidad }}</td>
                                <td>
                                    <code v-if="item.codigo">{{ item.codigo }}</code>
                                    <span v-else class="text-muted">—</span>
                                </td>
                                <td>
                                    <span class="badge" :class="getEstadoBadgeClass(item.estado)">{{ item.estado }}</span>
                                </td>
                                <td>
                                    <span class="badge" :class="item.insumo.inventariable ? 'badge-inventariable' : 'badge-no-inventariable'">
                                        {{ item.insumo.inventariable ? 'Inventariable' : 'Por cantidad' }}
                                    </span>
                                </td>
                                <td>{{ formatDate(item.ultimo_movimiento) }}</td>
                            </tr>
                            </tbody>
                        </table>
                        <div v-if="stockItems.length === 0" class="alert alert-info">
                            No hay stock registrado.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Catálogo de Insumos -->
        <div v-show="tab==='insumos'">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-8"><h5 class="mb-0">Catálogo de Insumos</h5></div>
                        <div class="col-md-4">
                            <input type="text" v-model="searchInsumos" class="form-control" placeholder="Buscar insumos...">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Reemplazar la tabla del catálogo de insumos -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Imagen</th>
                                <th>Nombre Completo</th>
                                <th>Tipo</th>
                                <th>Marca</th>
                                <th>Modelo</th>
                                <th>Inventariable</th>
                                <th>Fecha Creación</th>
                                <th>Acciones</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="insumo in filteredInsumos" :key="insumo.id">
                                <td>{{ insumo.id }}</td>
                                <td>
                                    <div class="text-center" style="width: 40px;">
                                        <img v-if="insumo.url_imagen" 
                                             :src="insumo.url_imagen" 
                                             :alt="insumo.nombre_completo"
                                             class="img-thumbnail"
                                             style="max-width: 30px; max-height: 30px; object-fit: cover;"
                                             @error="onImageError($event)">
                                        <div v-else class="bg-light rounded d-flex align-items-center justify-content-center" 
                                             style="width: 30px; height: 30px; font-size: 10px; color: #6c757d;">
                                            <i class="bi bi-image"></i>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <strong>{{ insumo.nombre_completo }}</strong>
                                    <small v-if="insumo.descripcion" class="text-muted d-block">{{ insumo.descripcion }}</small>
                                    <!-- Mostrar tóner y batería si existen -->
                                    <div class="mt-1">
                                        <span v-if="insumo.toner" class="badge bg-info me-1" style="font-size: 0.7em;">
                                            <i class="bi bi-printer"></i> {{ insumo.toner.nombre }}
                                        </span>
                                        <span v-if="insumo.bateria" class="badge bg-success" style="font-size: 0.7em;">
                                            <i class="bi bi-battery"></i> {{ insumo.bateria.cantidad }} mAh
                                        </span>
                                    </div>
                                </td>
                                <td>{{ insumo.tipo.nombre }}</td>
                                <td>{{ insumo.marca.nombre }}</td>
                                <td>{{ insumo.modelo.nombre }}</td>
                                <td>
                                    <span class="badge" :class="insumo.inventariable ? 'badge-inventariable' : 'badge-no-inventariable'">
                                        {{ insumo.inventariable ? 'Sí' : 'No' }}
                                    </span>
                                </td>
                                <td>{{ formatDate(insumo.fecha_creacion) }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                @click="editInsumo(insumo)" 
                                                title="Editar insumo">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                @click="confirmDeleteInsumo(insumo)" 
                                                title="Eliminar insumo">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Formulario para crear nuevo insumo -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Crear Nuevo Insumo</h5>
                </div>
                <div class="card-body">
                    <form @submit.prevent="createInsumo">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Tipo *</label>
                                <div class="input-group">
                                    <select class="form-select" v-model="newInsumo.tipo_id" required>
                                        <option value="">Seleccionar tipo</option>
                                        <option v-for="tipo in tiposProducto" :key="tipo.id" :value="tipo.id">{{ tipo.nombre }}</option>
                                    </select>
                                    <button class="btn btn-outline-primary" type="button" @click="showCreateModal('tipo')" title="Agregar nuevo tipo">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Marca *</label>
                                <div class="input-group">
                                    <select class="form-select" v-model="newInsumo.marca_id" required>
                                        <option value="">Seleccionar marca</option>
                                        <option v-for="marca in marcas" :key="marca.id" :value="marca.id">{{ marca.nombre }}</option>
                                    </select>
                                    <button class="btn btn-outline-primary" type="button" @click="showCreateModal('marca')" title="Agregar nueva marca">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Modelo *</label>
                                <div class="input-group">
                                    <select class="form-select" v-model="newInsumo.modelo_id" required>
                                        <option value="">Seleccionar modelo</option>
                                        <option v-for="modelo in modelosFiltered" :key="modelo.id" :value="modelo.id">{{ modelo.nombre }}</option>
                                    </select>
                                    <button class="btn btn-outline-primary" type="button" @click="showCreateModal('modelo')" title="Agregar nuevo modelo">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Descripción</label>
                                <input type="text" class="form-control" v-model="newInsumo.descripcion" placeholder="Descripción opcional">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Tóner</label>
                                <div class="input-group">
                                    <select class="form-select" v-model="newInsumo.toner_id" :disabled="!isImpresoraSelected">
                                        <option value="">Sin tóner</option>
                                        <option v-for="toner in toners" :key="toner.id" :value="toner.id">{{ toner.nombre }}</option>
                                    </select>
                                    <button class="btn btn-outline-primary" type="button" @click="showCreateModal('toner')" 
                                            title="Agregar nuevo tóner" :disabled="!isImpresoraSelected">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="form-text" v-if="!isImpresoraSelected">
                                    <small class="text-muted">Disponible solo para impresoras</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Batería</label>
                                <div class="input-group">
                                    <select class="form-select" v-model="newInsumo.bateria_id" :disabled="!isUpsSelected">
                                        <option value="">Sin batería</option>
                                        <option v-for="bateria in baterias" :key="bateria.id" :value="bateria.id">Cantidad: {{ bateria.cantidad }}</option>
                                    </select>
                                    <button class="btn btn-outline-primary" type="button" @click="showCreateModal('bateria')" 
                                            title="Agregar nueva batería" :disabled="!isUpsSelected">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="form-text" v-if="!isUpsSelected">
                                    <small class="text-muted">Disponible solo para UPS</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Imagen del Producto</label>
                                <div class="input-group">
                                    <input type="file" class="form-control" ref="imageFile" @change="onImageSelected" accept="image/*">
                                    <button type="button" class="btn btn-outline-secondary" @click="uploadImage" :disabled="!selectedImage || uploading">
                                        <i class="bi bi-cloud-upload" v-if="!uploading"></i>
                                        <span class="spinner-border spinner-border-sm" v-if="uploading"></span>
                                        {{ uploading ? 'Subiendo...' : 'Subir' }}
                                    </button>
                                </div>
                                <div class="form-text">Formatos permitidos: PNG, JPG, JPEG, GIF, WEBP</div>
                                
                                <!-- Preview de la imagen -->
                                <div v-if="newInsumo.url_imagen" class="mt-2">
                                    <img :src="newInsumo.url_imagen" class="img-thumbnail" style="max-width: 100px; max-height: 100px;">
                                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" @click="removeImage">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" v-model="newInsumo.inventariable" id="inventariable">
                                    <label class="form-check-label" for="inventariable">Inventariable</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Crear Insumo</button>
                                <button type="button" class="btn btn-secondary ms-2" @click="resetNewInsumoForm">Limpiar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- TAB: Imputar Stock -->
        <div v-show="tab==='imputar'">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Imputar Stock a Área</h5>
                </div>
                <div class="card-body">
                    <form @submit.prevent="imputarStock">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Insumo *</label>
                                <select class="form-select" v-model="imputacion.insumo_id" required>
                                    <option value="">Seleccionar insumo</option>
                                    <option v-for="insumo in insumos" :key="insumo.id" :value="insumo.id">
                                        {{ insumo.nombre_completo }}
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Área destino *</label>
                                <select class="form-select" v-model="imputacion.area_id" required>
                                    <option value="">Seleccionar área</option>
                                    <option v-for="area in areas" :key="area.id" :value="area.id">
                                        {{ area.nombre }} {{ area.es_deposito ? '(Depósito)' : '' }}
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Cantidad *</label>
                                <input type="number" class="form-control" v-model="imputacion.cantidad" min="1" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Responsable</label>
                                <input type="text" class="form-control" v-model="imputacion.responsable" placeholder="Nombre del responsable">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Observación</label>
                                <input type="text" class="form-control" v-model="imputacion.observacion" placeholder="Observación opcional">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Imputar Stock</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- TAB: Mover Stock -->
        <div v-show="tab==='mover'">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Mover Stock entre Áreas</h5>
                </div>
                <div class="card-body">
                    <form @submit.prevent="moverStock">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Stock origen *</label>
                                <select class="form-select" v-model="movimiento.stock_origen_id" required>
                                    <option value="">Seleccionar stock</option>
                                    <option v-for="item in stockItems" :key="item.id" :value="item.id">
                                        {{ item.insumo.nombre_completo }} - {{ item.area.nombre }} ({{ item.cantidad }})
                                        {{ item.codigo ? ' - ' + item.codigo : '' }}
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Área destino *</label>
                                <select class="form-select" v-model="movimiento.area_destino_id" required>
                                    <option value="">Seleccionar área</option>
                                    <option v-for="area in areas" :key="area.id" :value="area.id">
                                        {{ area.nombre }} {{ area.es_deposito ? '(Depósito)' : '' }}
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Cantidad a mover *</label>
                                <input type="number" class="form-control" v-model="movimiento.cantidad" min="1" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Responsable</label>
                                <input type="text" class="form-control" v-model="movimiento.responsable" placeholder="Nombre del responsable">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Observación</label>
                                <input type="text" class="form-control" v-model="movimiento.observacion" placeholder="Observación opcional">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-warning">Mover Stock</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast para mensajes -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="resultToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header" :class="toastClass">
                <strong class="me-auto" v-text="toastTitle"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" v-text="toastMessage"></div>
        </div>
    </div>

    <!-- Modal para crear nuevos elementos -->
    <div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createModalLabel">{{ modalTitle }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="createNewItem">
                        <!-- Formulario para Tipo, Marca -->
                        <div v-if="modalType === 'tipo' || modalType === 'marca'">
                            <div class="mb-3">
                                <label class="form-label">Nombre *</label>
                                <input type="text" class="form-control" v-model="newItem.nombre" required placeholder="Ingrese el nombre">
                            </div>
                        </div>
                        
                        <!-- Formulario para Modelo -->
                        <div v-if="modalType === 'modelo'">
                            <div class="mb-3">
                                <label class="form-label">Marca *</label>
                                <select class="form-select" v-model="newItem.marca_id" required>
                                    <option value="">Seleccionar marca</option>
                                    <option v-for="marca in marcas" :key="marca.id" :value="marca.id">{{ marca.nombre }}</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nombre del Modelo *</label>
                                <input type="text" class="form-control" v-model="newItem.nombre" required placeholder="Ingrese el nombre del modelo">
                            </div>
                        </div>
                        
                        <!-- Formulario para Tóner -->
                        <div v-if="modalType === 'toner'">
                            <div class="mb-3">
                                <label class="form-label">Nombre del Tóner *</label>
                                <input type="text" class="form-control" v-model="newItem.nombre" required placeholder="Ej: TN-2410" maxlength="8">
                                <div class="form-text">Máximo 8 caracteres</div>
                            </div>
                        </div>
                        
                        <!-- Formulario para Batería -->
                        <div v-if="modalType === 'bateria'">
                            <div class="mb-3">
                                <label class="form-label">Cantidad/Capacidad de la Batería *</label>
                                <input type="number" class="form-control" v-model="newItem.cantidad" required placeholder="Ej: 3000" min="1">
                                <div class="form-text">Capacidad en mAh u otra unidad</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @click="createNewItem" :disabled="!isFormValid">Crear {{ modalTypeName }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar insumo -->
    <div class="modal fade" id="editInsumoModal" tabindex="-1" aria-labelledby="editInsumoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editInsumoModalLabel">Editar Insumo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="updateInsumo" v-if="editingInsumo">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Tipo *</label>
                                <div class="input-group">
                                    <select class="form-select" v-model="editingInsumo.tipo_id" required>
                                        <option value="">Seleccionar tipo</option>
                                        <option v-for="tipo in tiposProducto" :key="tipo.id" :value="tipo.id">{{ tipo.nombre }}</option>
                                    </select>
                                    <button class="btn btn-outline-primary" type="button" @click="showCreateModal('tipo')" title="Agregar nuevo tipo">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Marca *</label>
                                <div class="input-group">
                                    <select class="form-select" v-model="editingInsumo.marca_id" required>
                                        <option value="">Seleccionar marca</option>
                                        <option v-for="marca in marcas" :key="marca.id" :value="marca.id">{{ marca.nombre }}</option>
                                    </select>
                                    <button class="btn btn-outline-primary" type="button" @click="showCreateModal('marca')" title="Agregar nueva marca">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Modelo *</label>
                                <div class="input-group">
                                    <select class="form-select" v-model="editingInsumo.modelo_id" required>
                                        <option value="">Seleccionar modelo</option>
                                        <option v-for="modelo in modelosFilteredEdit" :key="modelo.id" :value="modelo.id">{{ modelo.nombre }}</option>
                                    </select>
                                    <button class="btn btn-outline-primary" type="button" @click="showCreateModal('modelo')" title="Agregar nuevo modelo">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Descripción</label>
                                <input type="text" class="form-control" v-model="editingInsumo.descripcion" placeholder="Descripción opcional">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Tóner</label>
                                <div class="input-group">
                                    <select class="form-select" v-model="editingInsumo.toner_id" :disabled="!isImpresoraSelectedEdit">
                                        <option value="">Sin tóner</option>
                                        <option v-for="toner in toners" :key="toner.id" :value="toner.id">{{ toner.nombre }}</option>
                                    </select>
                                    <button class="btn btn-outline-primary" type="button" @click="showCreateModal('toner')" 
                                            title="Agregar nuevo tóner" :disabled="!isImpresoraSelectedEdit">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="form-text" v-if="!isImpresoraSelectedEdit">
                                    <small class="text-muted">Disponible solo para impresoras</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Batería</label>
                                <div class="input-group">
                                    <select class="form-select" v-model="editingInsumo.bateria_id" :disabled="!isUpsSelectedEdit">
                                        <option value="">Sin batería</option>
                                        <option v-for="bateria in baterias" :key="bateria.id" :value="bateria.id">Cantidad: {{ bateria.cantidad }}</option>
                                    </select>
                                    <button class="btn btn-outline-primary" type="button" @click="showCreateModal('bateria')" 
                                            title="Agregar nueva batería" :disabled="!isUpsSelectedEdit">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="form-text" v-if="!isUpsSelectedEdit">
                                    <small class="text-muted">Disponible solo para UPS</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Imagen del Producto</label>
                                <div class="input-group">
                                    <input type="file" class="form-control" ref="editImageFile" @change="onEditImageSelected" accept="image/*">
                                    <button type="button" class="btn btn-outline-secondary" @click="uploadEditImage" :disabled="!selectedEditImage || uploadingEdit">
                                        <i class="bi bi-cloud-upload" v-if="!uploadingEdit"></i>
                                        <span class="spinner-border spinner-border-sm" v-if="uploadingEdit"></span>
                                        {{ uploadingEdit ? 'Subiendo...' : 'Subir' }}
                                    </button>
                                </div>
                                <div class="form-text">Formatos permitidos: PNG, JPG, JPEG, GIF, WEBP</div>
                                
                                <!-- Preview de la imagen -->
                                <div v-if="editingInsumo.url_imagen" class="mt-2">
                                    <img :src="editingInsumo.url_imagen" class="img-thumbnail" style="max-width: 100px; max-height: 100px;">
                                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" @click="removeEditImage">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" v-model="editingInsumo.inventariable" id="editInventariable">
                                    <label class="form-check-label" for="editInventariable">Inventariable</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @click="updateInsumo" :disabled="!editingInsumo">
                        <i class="bi bi-check-lg"></i> Actualizar Insumo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" v-if="insumoToDelete">
                    <p>¿Está seguro de que desea eliminar el siguiente insumo?</p>
                    <div class="alert alert-warning">
                        <strong>{{ insumoToDelete.nombre_completo }}</strong>
                        <br><small>{{ insumoToDelete.tipo.nombre }} - {{ insumoToDelete.marca.nombre }} - {{ insumoToDelete.modelo.nombre }}</small>
                    </div>
                    <p class="text-danger"><strong>Esta acción no se puede deshacer.</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" @click="deleteInsumo">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
const { createApp } = Vue;
createApp({
    data() {
        return {
            tab: 'stock',
            stockItems: [],
            insumos: [],
            areas: [],
            tiposProducto: [],
            marcas: [],
            modelos: [],
            toners: [],
            baterias: [],
            
            searchStock: '',
            searchInsumos: '',
            loading: false,
            
            newInsumo: {
                tipo_id: '',
                marca_id: '',
                modelo_id: '',
                descripcion: '',
                inventariable: true,
                toner_id: '',
                bateria_id: '',
                url_imagen: ''
            },
            
            imputacion: {
                insumo_id: '',
                area_id: '',
                cantidad: 1,
                responsable: '',
                observacion: ''
            },
            
            movimiento: {
                stock_origen_id: '',
                area_destino_id: '',
                cantidad: 1,
                responsable: '',
                observacion: ''
            },
            
            toastMessage: '',
            toastTitle: '',
            toastClass: '',
            resultToast: null,
            
            // Nuevas propiedades para el modal
            modalType: '',
            modalTitle: '',
            modalTypeName: '',
            newItem: {
                nombre: '',
                marca_id: '',
                cantidad: ''
            },
            createModalInstance: null,
            
            // Nueva propiedad para filtrar stock
            stockFilter: 'todos',
            
            // Nuevas propiedades para la carga de imágenes
            selectedImage: null,
            uploading: false,
            
            // Nueva propiedad para editar insumo
            editingInsumo: null,
            selectedEditImage: null,
            uploadingEdit: false,
            insumoToDelete: null
        };
    },
    
    computed: {
        filteredStock() {
            if (!this.searchStock) return this.stockItems;
            const searchLower = this.searchStock.toLowerCase();
            return this.stockItems.filter(item => 
                item.insumo.nombre_completo.toLowerCase().includes(searchLower) ||
                item.area.nombre.toLowerCase().includes(searchLower) ||
                (item.codigo && item.codigo.toLowerCase().includes(searchLower))
            );
        },
        
        filteredInsumos() {
            if (!this.searchInsumos) return this.insumos;
            const searchLower = this.searchInsumos.toLowerCase();
            return this.insumos.filter(insumo => 
                insumo.nombre_completo.toLowerCase().includes(searchLower) ||
                insumo.tipo.nombre.toLowerCase().includes(searchLower) ||
                insumo.marca.nombre.toLowerCase().includes(searchLower) ||
                insumo.modelo.nombre.toLowerCase().includes(searchLower)
            );
        },
        
        modelosFiltered() {
            if (!this.newInsumo.marca_id) return [];
            return this.modelos.filter(modelo => modelo.marca_id == this.newInsumo.marca_id);
        },
        
        modelosFilteredEdit() {
            if (!this.editingInsumo.marca_id) return [];
            return this.modelos.filter(modelo => modelo.marca_id == this.editingInsumo.marca_id);
        },
        
        // Nueva propiedad computada para validar el formulario del modal
        isFormValid() {
            if (this.modalType === 'tipo' || this.modalType === 'marca' || this.modalType === 'toner') {
                return this.newItem.nombre && this.newItem.nombre.trim() !== '';
            }
            if (this.modalType === 'modelo') {
                return this.newItem.nombre && this.newItem.nombre.trim() !== '' && this.newItem.marca_id;
            }
            if (this.modalType === 'bateria') {
                return this.newItem.cantidad && this.newItem.cantidad > 0;
            }
            return false;
        },
        
        // Nuevas propiedades computadas para las vistas filtradas de stock
        filteredStockImpresoras() {
            let stockImpresoras = this.stockItems.filter(item => {
                // Filtrar por tipo "impresora" (ajusta según tu estructura de datos)
                return item.insumo.tipo && item.insumo.tipo.toLowerCase().includes('impresora');
            });
            
            if (!this.searchStock) return stockImpresoras;
            const searchLower = this.searchStock.toLowerCase();
            return stockImpresoras.filter(item => 
                item.insumo.nombre_completo.toLowerCase().includes(searchLower) ||
                item.area.nombre.toLowerCase().includes(searchLower) ||
                (item.codigo && item.codigo.toLowerCase().includes(searchLower)) ||
                (item.insumo.toner && item.insumo.toner.toLowerCase().includes(searchLower))
            );
        },
        
        filteredStockUps() {
            let stockUps = this.stockItems.filter(item => {
                // Filtrar por tipo "ups" (ajusta según tu estructura de datos)
                return item.insumo.tipo && item.insumo.tipo.toLowerCase().includes('ups');
            });
            
            if (!this.searchStock) return stockUps;
            const searchLower = this.searchStock.toLowerCase();
            return stockUps.filter(item => 
                item.insumo.nombre_completo.toLowerCase().includes(searchLower) ||
                item.area.nombre.toLowerCase().includes(searchLower) ||
                (item.codigo && item.codigo.toLowerCase().includes(searchLower)) ||
                (item.insumo.bateria && item.insumo.bateria.toString().includes(searchLower))
            );
        },
        
        // Nuevas propiedades computadas para habilitar/deshabilitar campos según selección
        isImpresoraSelected() {
            if (!this.newInsumo.tipo_id) return false;
            const tipoSeleccionado = this.tiposProducto.find(t => t.id == this.newInsumo.tipo_id);
            return tipoSeleccionado && tipoSeleccionado.nombre.toLowerCase().includes('impresora');
        },
        
        isUpsSelected() {
            if (!this.newInsumo.tipo_id) return false;
            const tipoSeleccionado = this.tiposProducto.find(t => t.id == this.newInsumo.tipo_id);
            return tipoSeleccionado && tipoSeleccionado.nombre.toLowerCase().includes('ups');
        },
        
        isImpresoraSelectedEdit() {
            if (!this.editingInsumo.tipo_id) return false;
            const tipoSeleccionado = this.tiposProducto.find(t => t.id == this.editingInsumo.tipo_id);
            return tipoSeleccionado && tipoSeleccionado.nombre.toLowerCase().includes('impresora');
        },
        
        isUpsSelectedEdit() {
            if (!this.editingInsumo.tipo_id) return false;
            const tipoSeleccionado = this.tiposProducto.find(t => t.id == this.editingInsumo.tipo_id);
            return tipoSeleccionado && tipoSeleccionado.nombre.toLowerCase().includes('ups');
        }
    },
    
    watch: {
        'newInsumo.tipo_id'(newVal, oldVal) {
            // Si cambió el tipo, limpiar tóner y batería según corresponda
            if (newVal !== oldVal) {
                // Si no es impresora, limpiar tóner
                if (!this.isImpresoraSelected) {
                    this.newInsumo.toner_id = '';
                }
                // Si no es UPS, limpiar batería
                if (!this.isUpsSelected) {
                    this.newInsumo.bateria_id = '';
                }
            }
        },
        'editingInsumo.tipo_id'(newVal, oldVal) {
            // Si cambió el tipo en edición, limpiar tóner y batería según corresponda
            if (newVal !== oldVal) {
                // Si no es impresora, limpiar tóner
                if (!this.isImpresoraSelectedEdit) {
                    this.editingInsumo.toner_id = '';
                }
                // Si no es UPS, limpiar batería
                if (!this.isUpsSelectedEdit) {
                    this.editingInsumo.bateria_id = '';
                }
            }
        }
    },
    
    methods: {
        async loadData() {
            this.loading = true;
            try {
                // Cargar datos en paralelo
                const [stockRes, insumosRes, areasRes, tiposRes, marcasRes, modelosRes, tonersRes, bateriasRes] = await Promise.all([
                    axios.get('/api/stock'),
                    axios.get('/api/stock/insumos'),
                    axios.get('/api/stock/areas'),
                    axios.get('/api/stock/tipos'),
                    axios.get('/api/stock/marcas'),
                    axios.get('/api/stock/modelos'),
                    axios.get('/api/stock/toners'),
                    axios.get('/api/stock/baterias')
                ]);
                
                this.stockItems = stockRes.data;
                this.insumos = insumosRes.data;
                this.areas = areasRes.data;
                this.tiposProducto = tiposRes.data;
                this.marcas = marcasRes.data;
                this.modelos = modelosRes.data;
                this.toners = tonersRes.data;
                this.baterias = bateriasRes.data;
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                this.showToast('Error', 'No se pudieron cargar los datos', 'bg-danger text-white');
            } finally {
                this.loading = false;
            }
        },
        
        async createInsumo() {
            this.loading = true;
            try {
                const response = await axios.post('/api/stock/insumos', this.newInsumo);
                if (response.data.success) {
                    this.showToast('Éxito', response.data.message, 'bg-success text-white');
                    this.resetNewInsumoForm();
                    await this.loadData();
                } else {
                    this.showToast('Error', response.data.message, 'bg-danger text-white');
                }
            } catch (error) {
                const message = error.response?.data?.message || 'Error al crear insumo';
                this.showToast('Error', message, 'bg-danger text-white');
            } finally {
                this.loading = false;
            }
        },
        
        async updateInsumo() {
            this.loading = true;
            try {
                const response = await axios.put(`/api/stock/insumos/${this.editingInsumo.id}`, this.editingInsumo);
                if (response.data.success) {
                    this.showToast('Éxito', 'Insumo actualizado correctamente', 'bg-success text-white');
                    this.editingInsumo = null;
                    await this.loadData();
                } else {
                    this.showToast('Error', response.data.message, 'bg-danger text-white');
                }
            } catch (error) {
                const message = error.response?.data?.message || 'Error al actualizar insumo';
                this.showToast('Error', message, 'bg-danger text-white');
            } finally {
                this.loading = false;
            }
        },
        
        async imputarStock() {
            this.loading = true;
            try {
                const response = await axios.post('/api/stock/imputar', this.imputacion);
                if (response.data.success) {
                    this.showToast('Éxito', response.data.message, 'bg-success text-white');
                    this.resetImputacionForm();
                    await this.loadData();
                } else {
                    this.showToast('Error', response.data.message, 'bg-danger text-white');
                }
            } catch (error) {
                const message = error.response?.data?.message || 'Error al imputar stock';
                this.showToast('Error', message, 'bg-danger text-white');
            } finally {
                this.loading = false;
            }
        },
        
        async moverStock() {
            this.loading = true;
            try {
                const response = await axios.post('/api/stock/mover', this.movimiento);
                if (response.data.success) {
                    this.showToast('Éxito', response.data.message, 'bg-success text-white');
                    this.resetMovimientoForm();
                    await this.loadData();
                } else {
                    this.showToast('Error', response.data.message, 'bg-danger text-white');
                }
            } catch (error) {
                const message = error.response?.data?.message || 'Error al mover stock';
                this.showToast('Error', message, 'bg-danger text-white');
            } finally {
                this.loading = false;
            }
        },
        
        resetNewInsumoForm() {
            this.newInsumo = {
                tipo_id: '',
                marca_id: '',
                modelo_id: '',
                descripcion: '',
                inventariable: true,
                toner_id: '',
                bateria_id: '',
                url_imagen: ''
            };
        },
        
        resetImputacionForm() {
            this.imputacion = {
                insumo_id: '',
                area_id: '',
                cantidad: 1,
                responsable: '',
                observacion: ''
            };
        },
        
        resetMovimientoForm() {
            this.movimiento = {
                stock_origen_id: '',
                area_destino_id: '',
                cantidad: 1,
                responsable: '',
                observacion: ''
            };
        },
        
        getEstadoBadgeClass(estado) {
            const classes = {
                'disponible': 'bg-success',
                'asignado': 'bg-primary',
                'en_reparacion': 'bg-warning',
                'baja': 'bg-danger'
            };
            return classes[estado] || 'bg-secondary';
        },
        
        formatDate(dateString) {
            if (!dateString) return '—';
            return new Date(dateString).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        showToast(title, message, headerClass = '') {
            this.toastTitle = title;
            this.toastMessage = message;
            this.toastClass = headerClass;
            if (!this.resultToast) {
                this.resultToast = new bootstrap.Toast(document.getElementById('resultToast'));
            }
            this.resultToast.show();
        },
        
        showCreateModal(type) {
            this.modalType = type;
            this.resetNewItemForm();
            
            const titles = {
                'tipo': 'Crear Nuevo Tipo de Producto',
                'marca': 'Crear Nueva Marca',
                'modelo': 'Crear Nuevo Modelo',
                'toner': 'Crear Nuevo Tóner',
                'bateria': 'Crear Nueva Batería'
            };
            
            const typeNames = {
                'tipo': 'Tipo',
                'marca': 'Marca',
                'modelo': 'Modelo',
                'toner': 'Tóner',
                'bateria': 'Batería'
            };
            
            this.modalTitle = titles[type];
            this.modalTypeName = typeNames[type];
            
            // Para modelo, preseleccionar la marca si está seleccionada
            if (type === 'modelo' && this.newInsumo.marca_id) {
                this.newItem.marca_id = this.newInsumo.marca_id;
            }
            
            if (!this.createModalInstance) {
                this.createModalInstance = new bootstrap.Modal(document.getElementById('createModal'));
            }
            this.createModalInstance.show();
        },
        
        async createNewItem() {
            if (!this.isFormValid) return;
            
            this.loading = true;
            try {
                let endpoint = '';
                let data = {};
                
                switch (this.modalType) {
                    case 'tipo':
                        endpoint = '/api/tipos';
                        data = { nombre: this.newItem.nombre.trim() };
                        break;
                    case 'marca':
                        endpoint = '/api/marcas';
                        data = { nombre: this.newItem.nombre.trim() };
                        break;
                    case 'modelo':
                        endpoint = '/api/modelos';
                        data = { 
                            nombre: this.newItem.nombre.trim(),
                            marca_id: this.newItem.marca_id
                        };
                        break;
                    case 'toner':
                        endpoint = '/api/toners_baterias';
                        data = { nombre: this.newItem.nombre.trim() };
                        break;
                    case 'bateria':
                        endpoint = '/api/baterias';
                        data = { cantidad: parseInt(this.newItem.cantidad) };
                        break;
                    default:
                        throw new Error('Tipo no válido');
                }
                
                const response = await axios.post(endpoint, data);
                
                if (response.data.success || response.data.mensaje) {
                    this.showToast('Éxito', `${this.modalTypeName} creado correctamente`, 'bg-success text-white');
                    
                    // Cerrar modal
                    this.createModalInstance.hide();
                    
                    // Recargar datos específicos según el tipo
                    await this.reloadSpecificData(this.modalType);
                    
                    // Auto-seleccionar el item recién creado
                    this.autoSelectNewItem(this.modalType, response.data);
                    
                } else {
                    this.showToast('Error', response.data.error || response.data.message || 'Error al crear el elemento', 'bg-danger text-white');
                }
                
            } catch (error) {
                const message = error.response?.data?.error || error.response?.data?.message || `Error al crear ${this.modalTypeName.toLowerCase()}`;
                this.showToast('Error', message, 'bg-danger text-white');
            } finally {
                this.loading = false;
            }
        },
        
        async reloadSpecificData(type) {
            try {
                switch (type) {
                    case 'tipo':
                        const tiposRes = await axios.get('/api/tipos');
                        this.tiposProducto = tiposRes.data;
                        break;
                    case 'marca':
                        const marcasRes = await axios.get('/api/marcas');
                        this.marcas = marcasRes.data;
                        break;
                    case 'modelo':
                        const modelosRes = await axios.get('/api/modelos');
                        this.modelos = modelosRes.data;
                        break;
                    case 'toner':
                        const tonersRes = await axios.get('/api/toners_baterias');
                        this.toners = tonersRes.data;
                        break;
                    case 'bateria':
                        const bateriasRes = await axios.get('/api/baterias');
                        this.baterias = bateriasRes.data;
                        break;
                }
            } catch (error) {
                console.error(`Error recargando ${type}:`, error);
            }
        },
        
        autoSelectNewItem(type, responseData) {
            // Auto-seleccionar el elemento recién creado
            let newId = null;
            
            if (responseData.id) {
                newId = responseData.id;
            } else if (responseData[type] && responseData[type].id) {
                newId = responseData[type].id;
            } else {
                // Buscar el último elemento agregado
                switch (type) {
                    case 'tipo':
                        if (this.tiposProducto.length > 0) {
                            newId = this.tiposProducto[this.tiposProducto.length - 1].id;
                        }
                        break;
                    case 'marca':
                        if (this.marcas.length > 0) {
                            newId = this.marcas[this.marcas.length - 1].id;
                        }
                        break;
                    case 'modelo':
                        if (this.modelos.length > 0) {
                            newId = this.modelos[this.modelos.length - 1].id;
                        }
                        break;
                    case 'toner':
                        if (this.toners.length > 0) {
                            newId = this.toners[this.toners.length - 1].id;
                        }
                        break;
                    case 'bateria':
                        if (this.baterias.length > 0) {
                            newId = this.baterias[this.baterias.length - 1].id;
                        }
                        break;
                }
            }
            
            // Asignar el ID al formulario principal
            if (newId) {
                switch (type) {
                    case 'tipo':
                        this.newInsumo.tipo_id = newId;
                        break;
                    case 'marca':
                        this.newInsumo.marca_id = newId;
                        break;
                    case 'modelo':
                        this.newInsumo.modelo_id = newId;
                        break;
                    case 'toner':
                        this.newInsumo.toner_id = newId;
                        break;
                    case 'bateria':
                        this.newInsumo.bateria_id = newId;
                        break;
                }
            }
        },
        
        resetNewItemForm() {
            this.newItem = {
                nombre: '',
                marca_id: '',
                cantidad: ''
            };
        },
        
        // Nueva función para manejar errores de imagen
        onImageError(event) {
            event.target.src = 'https://via.placeholder.com/50x50?text=Sin+imagen';
        },
        
        onImageSelected(event) {
            const file = event.target.files[0];
            if (file) {
                this.selectedImage = file;
            }
        },
        
        async uploadImage() {
            if (!this.selectedImage) return;
            
            this.uploading = true;
            try {
                const formData = new FormData();
                formData.append('file', this.selectedImage);
                
                // Determinar categoría basada en el tipo seleccionado
                let categoria = 'otros';
                if (this.newInsumo.tipo_id) {
                    const tipo = this.tiposProducto.find(t => t.id == this.newInsumo.tipo_id);
                    if (tipo && tipo.nombre.toLowerCase().includes('impresora')) {
                        categoria = 'impresoras';
                    } else if (tipo && tipo.nombre.toLowerCase().includes('ups')) {
                        categoria = 'ups';
                    }
                }
                
                formData.append('categoria', categoria);
                
                const response = await axios.post('/api/upload/imagen', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                if (response.data.success) {
                    this.newInsumo.url_imagen = response.data.url;
                    this.selectedImage = null;
                    this.$refs.imageFile.value = '';
                    this.showToast('Éxito', 'Imagen subida correctamente', 'bg-success text-white');
                } else {
                    this.showToast('Error', response.data.message, 'bg-danger text-white');
                }
                
            } catch (error) {
                const message = error.response?.data?.message || 'Error al subir imagen';
                this.showToast('Error', message, 'bg-danger text-white');
            } finally {
                this.uploading = false;
            }
        },
        
        async removeImage() {
            if (this.newInsumo.url_imagen) {
                try {
                    // Extraer filename de la URL
                    const filename = this.newInsumo.url_imagen.split('/').pop();
                    await axios.delete(`/api/upload/imagen/${filename}`);
                    this.newInsumo.url_imagen = '';
                    this.showToast('Éxito', 'Imagen eliminada', 'bg-success text-white');
                } catch (error) {
                    console.error('Error al eliminar imagen:', error);
                }
            }
        },
        
        async uploadEditImage() {
            if (!this.selectedEditImage) return;
            
            this.uploadingEdit = true;
            try {
                const formData = new FormData();
                formData.append('file', this.selectedEditImage);
                
                // Determinar categoría basada en el tipo seleccionado
                let categoria = 'otros';
                if (this.editingInsumo.tipo_id) {
                    const tipo = this.tiposProducto.find(t => t.id == this.editingInsumo.tipo_id);
                    if (tipo && tipo.nombre.toLowerCase().includes('impresora')) {
                        categoria = 'impresoras';
                    } else if (tipo && tipo.nombre.toLowerCase().includes('ups')) {
                        categoria = 'ups';
                    }
                }
                
                formData.append('categoria', categoria);
                
                const response = await axios.post('/api/upload/imagen', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                if (response.data.success) {
                    this.editingInsumo.url_imagen = response.data.url;
                    this.selectedEditImage = null;
                    this.$refs.editImageFile.value = '';
                    this.showToast('Éxito', 'Imagen subida correctamente', 'bg-success text-white');
                } else {
                    this.showToast('Error', response.data.message, 'bg-danger text-white');
                }
                
            } catch (error) {
                const message = error.response?.data?.message || 'Error al subir imagen';
                this.showToast('Error', message, 'bg-danger text-white');
            } finally {
                this.uploadingEdit = false;
            }
        },
        
        async removeEditImage() {
            if (this.editingInsumo.url_imagen) {
                try {
                    // Extraer filename de la URL
                    const filename = this.editingInsumo.url_imagen.split('/').pop();
                    await axios.delete(`/api/upload/imagen/${filename}`);
                    this.editingInsumo.url_imagen = '';
                    this.showToast('Éxito', 'Imagen eliminada', 'bg-success text-white');
                } catch (error) {
                    console.error('Error al eliminar imagen:', error);
                }
            }
        },
        
        editInsumo(insumo) {
            this.editingInsumo = { ...insumo };
            
            // Ajustar el formato de la fecha para la edición
            this.editingInsumo.fecha_creacion = this.formatDate(insumo.fecha_creacion);
            
            // Mostrar el modal de edición
            const modal = new bootstrap.Modal(document.getElementById('editInsumoModal'));
            modal.show();
        },
        
        confirmDeleteInsumo(insumo) {
            this.insumoToDelete = insumo;
            
            // Mostrar el modal de confirmación
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        },
        
        async deleteInsumo() {
            if (!this.insumoToDelete) return;
            
            this.loading = true;
            try {
                const response = await axios.delete(`/api/stock/insumos/${this.insumoToDelete.id}`);
                if (response.data.success) {
                    this.showToast('Éxito', 'Insumo eliminado correctamente', 'bg-success text-white');
                    this.insumoToDelete = null;
                    await this.loadData();
                } else {
                    this.showToast('Error', response.data.message, 'bg-danger text-white');
                }
            } catch (error) {
                const message = error.response?.data?.message || 'Error al eliminar insumo';
                this.showToast('Error', message, 'bg-danger text-white');
            } finally {
                this.loading = false;
            }
        }
    },
    
    mounted() {
        this.loadData();
    }
}).mount('#app');
</script>
</body>
</html>