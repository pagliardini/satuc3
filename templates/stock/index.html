<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Stock - SATUCC3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
        .nav-tabs .nav-link.active { font-weight: bold; border-bottom: 3px solid #0d6efd; }
        .table-responsive { max-height: 500px; overflow-y: auto; }
        .table th { position: sticky; top: 0; background-color: white; z-index: 1; }
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; justify-content:center; align-items:center; z-index:9999; }
        .spinner-border { width: 3rem; height: 3rem; }
        .badge-inventariable { background-color: #198754; }
        .badge-no-inventariable { background-color: #6c757d; }
    </style>
</head>
<body>
<div id="app">
    {% raw %}
    <!-- Overlay de carga -->
    <div id="loading-overlay" v-if="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
    
    <div class="container mt-4">
        <h1 class="mb-4">Gestión de Stock</h1>
        
        <!-- Pestañas -->
        <ul class="nav nav-tabs mb-3" id="stockTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" :class="{active: tab==='stock'}" @click="tab='stock'" type="button">Stock Actual</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" :class="{active: tab==='insumos'}" @click="tab='insumos'" type="button">Catálogo de Insumos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" :class="{active: tab==='imputar'}" @click="tab='imputar'" type="button">Imputar Stock</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" :class="{active: tab==='mover'}" @click="tab='mover'" type="button">Mover Stock</button>
            </li>
        </ul>

        <!-- TAB: Stock Actual -->
        <div v-show="tab==='stock'">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-8"><h5 class="mb-0">Stock Actual por Ubicación</h5></div>
                        <div class="col-md-4">
                            <input type="text" v-model="searchStock" class="form-control" placeholder="Buscar en stock...">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Insumo</th>
                                <th>Área</th>
                                <th>Cantidad</th>
                                <th>Código</th>
                                <th>Estado</th>
                                <th>Tipo</th>
                                <th>Último Movimiento</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="item in filteredStock" :key="item.id">
                                <td>
                                    <div>
                                        <strong>{{ item.insumo.nombre_completo }}</strong>
                                        <small v-if="item.insumo.descripcion" class="text-muted d-block">{{ item.insumo.descripcion }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge" :class="item.area.es_deposito ? 'bg-warning' : 'bg-primary'">
                                        {{ item.area.nombre }}
                                    </span>
                                </td>
                                <td>{{ item.cantidad }}</td>
                                <td>
                                    <code v-if="item.codigo">{{ item.codigo }}</code>
                                    <span v-else class="text-muted">—</span>
                                </td>
                                <td>
                                    <span class="badge" :class="getEstadoBadgeClass(item.estado)">{{ item.estado }}</span>
                                </td>
                                <td>
                                    <span class="badge" :class="item.insumo.inventariable ? 'badge-inventariable' : 'badge-no-inventariable'">
                                        {{ item.insumo.inventariable ? 'Inventariable' : 'Por cantidad' }}
                                    </span>
                                </td>
                                <td>{{ formatDate(item.ultimo_movimiento) }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div v-if="stockItems.length === 0" class="alert alert-info">
                        No hay stock registrado.
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Catálogo de Insumos -->
        <div v-show="tab==='insumos'">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-8"><h5 class="mb-0">Catálogo de Insumos</h5></div>
                        <div class="col-md-4">
                            <input type="text" v-model="searchInsumos" class="form-control" placeholder="Buscar insumos...">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre Completo</th>
                                <th>Tipo</th>
                                <th>Marca</th>
                                <th>Modelo</th>
                                <th>Inventariable</th>
                                <th>Fecha Creación</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="insumo in filteredInsumos" :key="insumo.id">
                                <td>{{ insumo.id }}</td>
                                <td>
                                    <strong>{{ insumo.nombre_completo }}</strong>
                                    <small v-if="insumo.descripcion" class="text-muted d-block">{{ insumo.descripcion }}</small>
                                </td>
                                <td>{{ insumo.tipo.nombre }}</td>
                                <td>{{ insumo.marca.nombre }}</td>
                                <td>{{ insumo.modelo.nombre }}</td>
                                <td>
                                    <span class="badge" :class="insumo.inventariable ? 'badge-inventariable' : 'badge-no-inventariable'">
                                        {{ insumo.inventariable ? 'Sí' : 'No' }}
                                    </span>
                                </td>
                                <td>{{ formatDate(insumo.fecha_creacion) }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Formulario para crear nuevo insumo -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Crear Nuevo Insumo</h5>
                </div>
                <div class="card-body">
                    <form @submit.prevent="createInsumo">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Tipo *</label>
                                <select class="form-select" v-model="newInsumo.tipo_id" required>
                                    <option value="">Seleccionar tipo</option>
                                    <option v-for="tipo in tiposProducto" :key="tipo.id" :value="tipo.id">{{ tipo.nombre }}</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Marca *</label>
                                <select class="form-select" v-model="newInsumo.marca_id" required>
                                    <option value="">Seleccionar marca</option>
                                    <option v-for="marca in marcas" :key="marca.id" :value="marca.id">{{ marca.nombre }}</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Modelo *</label>
                                <select class="form-select" v-model="newInsumo.modelo_id" required>
                                    <option value="">Seleccionar modelo</option>
                                    <option v-for="modelo in modelos" :key="modelo.id" :value="modelo.id">{{ modelo.nombre }}</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Descripción</label>
                                <input type="text" class="form-control" v-model="newInsumo.descripcion" placeholder="Descripción opcional">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Tóner</label>
                                <select class="form-select" v-model="newInsumo.toner_id">
                                    <option value="">Sin tóner</option>
                                    <option v-for="toner in toners" :key="toner.id" :value="toner.id">{{ toner.nombre }}</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Batería</label>
                                <select class="form-select" v-model="newInsumo.bateria_id">
                                    <option value="">Sin batería</option>
                                    <option v-for="bateria in baterias" :key="bateria.id" :value="bateria.id">Cantidad: {{ bateria.cantidad }}</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">URL Imagen</label>
                                <input type="url" class="form-control" v-model="newInsumo.url_imagen" placeholder="https://...">
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" v-model="newInsumo.inventariable" id="inventariable">
                                    <label class="form-check-label" for="inventariable">Inventariable</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Crear Insumo</button>
                                <button type="button" class="btn btn-secondary ms-2" @click="resetNewInsumoForm">Limpiar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- TAB: Imputar Stock -->
        <div v-show="tab==='imputar'">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Imputar Stock a Área</h5>
                </div>
                <div class="card-body">
                    <form @submit.prevent="imputarStock">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Insumo *</label>
                                <select class="form-select" v-model="imputacion.insumo_id" required>
                                    <option value="">Seleccionar insumo</option>
                                    <option v-for="insumo in insumos" :key="insumo.id" :value="insumo.id">
                                        {{ insumo.nombre_completo }}
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Área destino *</label>
                                <select class="form-select" v-model="imputacion.area_id" required>
                                    <option value="">Seleccionar área</option>
                                    <option v-for="area in areas" :key="area.id" :value="area.id">
                                        {{ area.nombre }} {{ area.es_deposito ? '(Depósito)' : '' }}
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Cantidad *</label>
                                <input type="number" class="form-control" v-model="imputacion.cantidad" min="1" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Responsable</label>
                                <input type="text" class="form-control" v-model="imputacion.responsable" placeholder="Nombre del responsable">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Observación</label>
                                <input type="text" class="form-control" v-model="imputacion.observacion" placeholder="Observación opcional">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Imputar Stock</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- TAB: Mover Stock -->
        <div v-show="tab==='mover'">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Mover Stock entre Áreas</h5>
                </div>
                <div class="card-body">
                    <form @submit.prevent="moverStock">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Stock origen *</label>
                                <select class="form-select" v-model="movimiento.stock_origen_id" required>
                                    <option value="">Seleccionar stock</option>
                                    <option v-for="item in stockItems" :key="item.id" :value="item.id">
                                        {{ item.insumo.nombre_completo }} - {{ item.area.nombre }} ({{ item.cantidad }})
                                        {{ item.codigo ? ' - ' + item.codigo : '' }}
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Área destino *</label>
                                <select class="form-select" v-model="movimiento.area_destino_id" required>
                                    <option value="">Seleccionar área</option>
                                    <option v-for="area in areas" :key="area.id" :value="area.id">
                                        {{ area.nombre }} {{ area.es_deposito ? '(Depósito)' : '' }}
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Cantidad a mover *</label>
                                <input type="number" class="form-control" v-model="movimiento.cantidad" min="1" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Responsable</label>
                                <input type="text" class="form-control" v-model="movimiento.responsable" placeholder="Nombre del responsable">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Observación</label>
                                <input type="text" class="form-control" v-model="movimiento.observacion" placeholder="Observación opcional">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-warning">Mover Stock</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast para mensajes -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="resultToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header" :class="toastClass">
                <strong class="me-auto" v-text="toastTitle"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" v-text="toastMessage"></div>
        </div>
    </div>
    {% endraw %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
const { createApp } = Vue;
createApp({
    data() {
        return {
            tab: 'stock',
            stockItems: [],
            insumos: [],
            areas: [],
            tiposProducto: [],
            marcas: [],
            modelos: [],
            toners: [],
            baterias: [],
            
            searchStock: '',
            searchInsumos: '',
            loading: false,
            
            newInsumo: {
                tipo_id: '',
                marca_id: '',
                modelo_id: '',
                descripcion: '',
                inventariable: true,
                toner_id: '',
                bateria_id: '',
                url_imagen: ''
            },
            
            imputacion: {
                insumo_id: '',
                area_id: '',
                cantidad: 1,
                responsable: '',
                observacion: ''
            },
            
            movimiento: {
                stock_origen_id: '',
                area_destino_id: '',
                cantidad: 1,
                responsable: '',
                observacion: ''
            },
            
            toastMessage: '',
            toastTitle: '',
            toastClass: '',
            resultToast: null
        };
    },
    
    computed: {
        filteredStock() {
            if (!this.searchStock) return this.stockItems;
            const searchLower = this.searchStock.toLowerCase();
            return this.stockItems.filter(item => 
                item.insumo.nombre_completo.toLowerCase().includes(searchLower) ||
                item.area.nombre.toLowerCase().includes(searchLower) ||
                (item.codigo && item.codigo.toLowerCase().includes(searchLower))
            );
        },
        
        filteredInsumos() {
            if (!this.searchInsumos) return this.insumos;
            const searchLower = this.searchInsumos.toLowerCase();
            return this.insumos.filter(insumo => 
                insumo.nombre_completo.toLowerCase().includes(searchLower) ||
                insumo.tipo.nombre.toLowerCase().includes(searchLower) ||
                insumo.marca.nombre.toLowerCase().includes(searchLower) ||
                insumo.modelo.nombre.toLowerCase().includes(searchLower)
            );
        }
    },
    
    methods: {
        async loadData() {
            this.loading = true;
            try {
                // Cargar datos en paralelo
                const [stockRes, insumosRes, areasRes, tiposRes, marcasRes, modelosRes, tonersRes, bateriasRes] = await Promise.all([
                    axios.get('/api/stock'),
                    axios.get('/api/insumos'),
                    axios.get('/api/areas'),
                    axios.get('/api/tipos'),
                    axios.get('/api/marcas'),
                    axios.get('/api/modelos'),
                    axios.get('/api/toners'),
                    axios.get('/api/baterias')
                ]);
                
                this.stockItems = stockRes.data;
                this.insumos = insumosRes.data;
                this.areas = areasRes.data;
                this.tiposProducto = tiposRes.data;
                this.marcas = marcasRes.data;
                this.modelos = modelosRes.data;
                this.toners = tonersRes.data;
                this.baterias = bateriasRes.data;
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                this.showToast('Error', 'No se pudieron cargar los datos', 'bg-danger text-white');
            } finally {
                this.loading = false;
            }
        },
        
        async createInsumo() {
            this.loading = true;
            try {
                const response = await axios.post('/api/stock/insumos', this.newInsumo);
                if (response.data.success) {
                    this.showToast('Éxito', response.data.message, 'bg-success text-white');
                    this.resetNewInsumoForm();
                    await this.loadData();
                } else {
                    this.showToast('Error', response.data.message, 'bg-danger text-white');
                }
            } catch (error) {
                const message = error.response?.data?.message || 'Error al crear insumo';
                this.showToast('Error', message, 'bg-danger text-white');
            } finally {
                this.loading = false;
            }
        },
        
        async imputarStock() {
            this.loading = true;
            try {
                const response = await axios.post('/api/stock/imputar', this.imputacion);
                if (response.data.success) {
                    this.showToast('Éxito', response.data.message, 'bg-success text-white');
                    this.resetImputacionForm();
                    await this.loadData();
                } else {
                    this.showToast('Error', response.data.message, 'bg-danger text-white');
                }
            } catch (error) {
                const message = error.response?.data?.message || 'Error al imputar stock';
                this.showToast('Error', message, 'bg-danger text-white');
            } finally {
                this.loading = false;
            }
        },
        
        async moverStock() {
            this.loading = true;
            try {
                const response = await axios.post('/api/stock/mover', this.movimiento);
                if (response.data.success) {
                    this.showToast('Éxito', response.data.message, 'bg-success text-white');
                    this.resetMovimientoForm();
                    await this.loadData();
                } else {
                    this.showToast('Error', response.data.message, 'bg-danger text-white');
                }
            } catch (error) {
                const message = error.response?.data?.message || 'Error al mover stock';
                this.showToast('Error', message, 'bg-danger text-white');
            } finally {
                this.loading = false;
            }
        },
        
        resetNewInsumoForm() {
            this.newInsumo = {
                tipo_id: '',
                marca_id: '',
                modelo_id: '',
                descripcion: '',
                inventariable: true,
                toner_id: '',
                bateria_id: '',
                url_imagen: ''
            };
        },
        
        resetImputacionForm() {
            this.imputacion = {
                insumo_id: '',
                area_id: '',
                cantidad: 1,
                responsable: '',
                observacion: ''
            };
        },
        
        resetMovimientoForm() {
            this.movimiento = {
                stock_origen_id: '',
                area_destino_id: '',
                cantidad: 1,
                responsable: '',
                observacion: ''
            };
        },
        
        getEstadoBadgeClass(estado) {
            const classes = {
                'disponible': 'bg-success',
                'asignado': 'bg-primary',
                'en_reparacion': 'bg-warning',
                'baja': 'bg-danger'
            };
            return classes[estado] || 'bg-secondary';
        },
        
        formatDate(dateString) {
            if (!dateString) return '—';
            return new Date(dateString).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        showToast(title, message, headerClass = '') {
            this.toastTitle = title;
            this.toastMessage = message;
            this.toastClass = headerClass;
            if (!this.resultToast) {
                this.resultToast = new bootstrap.Toast(document.getElementById('resultToast'));
            }
            this.resultToast.show();
        }
    },
    
    mounted() {
        this.loadData();
    }
}).mount('#app');
</script>
</body>
</html>